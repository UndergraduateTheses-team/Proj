name: Build and Deploy to VM

on:
  workflow_dispatch:
  #push:
  #  branches:
  #    - mai

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  IMAGE_FE: fe
  IMAGE_BE: be
  IMAGE_TAG: latest
  GAR_ZONE: us-central1

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: development

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - id: 'auth'
        uses: 'google-github-actions/auth@v2.1.7'
        with:
          credentials_json: '${{ secrets.GKE_SA_KEY }}'


      - name: Install Node.js and npm
        run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm
  

      - name: Install Dependencies
        working-directory: webphim
        run: npm install
  

      - name: Build Project
        working-directory: webphim
        run: npm run build
  

      - name: Deploy to Server (Copy Build Files)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          scp -r -i private_key.pem webphim/build/* huahogiahuy_21042003@fe:/var/www/html/
          scp -r Server/ USER@external_ip:/home/user/Proj/Server/